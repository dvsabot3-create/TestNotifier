/*! For license information please see background.js.LICENSE.txt */
(()=>{function e(n){return e='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(e){return typeof e;}:function(e){return e&&'function'==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?'symbol':typeof e;},e(n);}function n(e,n){var o='undefined'!=typeof Symbol&&e[Symbol.iterator]||e['@@iterator'];if(!o){if(Array.isArray(e)||(o=function(e,n){if(e){if('string'==typeof e)return t(e,n);var o={}.toString.call(e).slice(8,-1);return'Object'===o&&e.constructor&&(o=e.constructor.name),'Map'===o||'Set'===o?Array.from(e):'Arguments'===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?t(e,n):void 0;}}(e))||n&&e&&'number'==typeof e.length){o&&(e=o);var i=0,r=function(){};return{ s:r,n:function(){return i>=e.length?{ done:!0 }:{ done:!1,value:e[i++] };},e:function(e){throw e;},f:r };}throw new TypeError('Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.');}var a,s=!0,c=!1;return{ s:function(){o=o.call(e);},n:function(){var e=o.next();return s=e.done,e;},e:function(e){c=!0,a=e;},f:function(){try{s||null==o.return||o.return();}finally{if(c)throw a;}} };}function t(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,o=Array(n);t<n;t++)o[t]=e[t];return o;}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable;})),t.push.apply(t,o);}return t;}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach(function(n){r(e,n,t[n]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n));});}return e;}function r(n,t,o){return(t=function(n){var t=function(n){if('object'!=e(n)||!n)return n;var t=n[Symbol.toPrimitive];if(void 0!==t){var o=t.call(n,'string');if('object'!=e(o))return o;throw new TypeError('@@toPrimitive must return a primitive value.');}return String(n);}(n);return'symbol'==e(t)?t:t+'';}(t))in n?Object.defineProperty(n,t,{ value:o,enumerable:!0,configurable:!0,writable:!0 }):n[t]=o,n;}function a(){var e,n,t='function'==typeof Symbol?Symbol:{},o=t.iterator||'@@iterator',i=t.toStringTag||'@@toStringTag';function r(t,o,i,r){var a=o&&o.prototype instanceof u?o:u,l=Object.create(a.prototype);return s(l,'_invoke',function(t,o,i){var r,a,s,u=0,l=i||[],p=!1,f={ p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(n,t){return r=n,a=0,s=e,f.n=t,c;} };function d(t,o){for(a=t,s=o,n=0;!p&&u&&!i&&n<l.length;n++){var i,r=l[n],d=f.p,g=r[2];t>3?(i=g===o)&&(s=r[(a=r[4])?5:(a=3,3)],r[4]=r[5]=e):r[0]<=d&&((i=t<2&&d<r[1])?(a=0,f.v=o,f.n=r[1]):d<g&&(i=t<3||r[0]>o||o>g)&&(r[4]=t,r[5]=o,f.n=g,a=0));}if(i||t>1)return c;throw p=!0,o;}return function(i,l,g){if(u>1)throw TypeError('Generator is already running');for(p&&1===l&&d(l,g),a=l,s=g;(n=a<2?e:s)||!p;){r||(a?a<3?(a>1&&(f.n=-1),d(a,s)):f.n=s:f.v=s);try{if(u=2,r){if(a||(i='next'),n=r[i]){if(!(n=n.call(r,s)))throw TypeError('iterator result is not an object');if(!n.done)return n;s=n.value,a<2&&(a=0);}else 1===a&&(n=r.return)&&n.call(r),a<2&&(s=TypeError('The iterator does not provide a \''+i+'\' method'),a=1);r=e;}else if((n=(p=f.n<0)?s:t.call(o,f))!==c)break;}catch(n){r=e,a=1,s=n;}finally{u=1;}}return{ value:n,done:p };};}(t,i,r),!0),l;}var c={};function u(){}function l(){}function p(){}n=Object.getPrototypeOf;var f=[][o]?n(n([][o]())):(s(n={},o,function(){return this;}),n),d=p.prototype=u.prototype=Object.create(f);function g(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,s(e,i,'GeneratorFunction')),e.prototype=Object.create(d),e;}return l.prototype=p,s(d,'constructor',p),s(p,'constructor',l),l.displayName='GeneratorFunction',s(p,i,'GeneratorFunction'),s(d),s(d,i,'Generator'),s(d,o,function(){return this;}),s(d,'toString',function(){return'[object Generator]';}),(a=function(){return{ w:r,m:g };})();}function s(e,n,t,o){var i=Object.defineProperty;try{i({},'',{});}catch(e){i=0;}s=function(e,n,t,o){function r(n,t){s(e,n,function(e){return this._invoke(n,t,e);});}n?i?i(e,n,{ value:t,enumerable:!o,configurable:!o,writable:!o }):e[n]=t:(r('next',0),r('throw',1),r('return',2));},s(e,n,t,o);}function c(e,n,t,o,i,r,a){try{var s=e[r](a),c=s.value;}catch(e){return void t(e);}s.done?n(c):Promise.resolve(c).then(o,i);}function u(e){return function(){var n=this,t=arguments;return new Promise(function(o,i){var r=e.apply(n,t);function a(e){c(r,o,i,a,s,'next',e);}function s(e){c(r,o,i,a,s,'throw',e);}a(void 0);});};}var l={ isActive:!1,currentInstructor:null,pupils:[],subscription:{ tier:'free',status:'inactive',expiresAt:null,features:{ maxTestCenters:1,maxRebooks:0,rapidMode:!1,bulkOperations:!1,advancedFiltering:!1,stealthMode:!1,multiPupil:!1,smsNotifications:!1,whatsappNotifications:!1,emailNotifications:!1 } },settings:{ autoCheck:!0,checkInterval:15e3,soundEnabled:!0,notifications:!0,twilio:{ accountSid:'',authToken:'',phoneNumber:'' },email:{ smtpHost:'',smtpPort:587,username:'',password:'',fromAddress:'' } } };function p(){return(p=u(a().m(function e(){var n,t;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,chrome.storage.local.get('extensionState');case 1:return n=e.v,e.a(2,n.extensionState||l);case 2:return e.p=2,t=e.v,console.error('❌ Error getting extension state:',t),e.a(2,l);}},e,null,[[0,2]]);}))).apply(this,arguments);}function f(){return(f=u(a().m(function e(n){var t;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,l=i(i({},l),n),e.n=1,chrome.storage.local.set({ extensionState:l });case 1:console.log('✅ Extension state updated'),e.n=3;break;case 2:e.p=2,t=e.v,console.error('❌ Error updating extension state:',t);case 3:return e.a(2);}},e,null,[[0,2]]);}))).apply(this,arguments);}function d(){return(d=u(a().m(function e(){var n,t;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,chrome.storage.local.get('settings');case 1:return n=e.v,e.a(2,n.settings||l.settings);case 2:return e.p=2,t=e.v,console.error('❌ Error getting settings:',t),e.a(2,l.settings);}},e,null,[[0,2]]);}))).apply(this,arguments);}function g(){return(g=u(a().m(function e(n){var t;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,l.settings=i(i({},l.settings),n),e.n=1,chrome.storage.local.set({ settings:l.settings });case 1:chrome.tabs.query({ url:'*://driverpracticaltest.dvsa.gov.uk/*' },function(e){e.forEach(function(e){chrome.tabs.sendMessage(e.id,{ action:'settingsUpdated',settings:l.settings });});}),console.log('✅ Settings updated'),e.n=3;break;case 2:e.p=2,t=e.v,console.error('❌ Error updating settings:',t);case 3:return e.a(2);}},e,null,[[0,2]]);}))).apply(this,arguments);}function m(){return(m=u(a().m(function e(n,t){var o,i,r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(console.log('🎯 Cancellation found:',n),o=l.pupils.find(function(e){return e.name===n.pupilName;})){e.n=1;break;}return console.warn('⚠️ Pupil not found in database, sending basic notification only'),l.settings.notifications&&chrome.notifications.create({ type:'basic',iconUrl:'icons/professional/icon128.png',title:'TestNotifier - Cancellation Found!',message:'Earlier test available for '.concat(n.pupilName,': ').concat(n.newDate,' at ').concat(n.newCentre) }),l.settings.soundEnabled&&new Audio(chrome.runtime.getURL('sounds/notification.mp3')).play().catch(function(){}),e.a(2);case 1:return e.p=1,e.n=2,R(o,'cancellation_found',n);case 2:i=e.v,console.log('✅ Multi-channel notification sent:',i),e.n=4;break;case 3:e.p=3,r=e.v,console.error('❌ Error sending multi-channel notification:',r),l.settings.notifications&&chrome.notifications.create({ type:'basic',iconUrl:'icons/professional/icon128.png',title:'TestNotifier - Cancellation Found!',message:'Earlier test available for '.concat(n.pupilName,': ').concat(n.newDate,' at ').concat(n.newCentre) });case 4:l.settings.soundEnabled&&new Audio(chrome.runtime.getURL('sounds/notification.mp3')).play().catch(function(){});case 5:return e.a(2);}},e,null,[[1,3]]);}))).apply(this,arguments);}function h(){return(h=u(a().m(function e(n,t){var o,i,r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(console.log('✅ Booking changed successfully:',n),o=l.pupils.find(function(e){return e.name===n.pupilName;})){e.n=1;break;}return console.warn('⚠️ Pupil not found in database, sending basic notification only'),chrome.notifications.create({ type:'basic',iconUrl:'icons/professional/icon128.png',title:'TestNotifier - Booking Changed!',message:'Test moved from '.concat(n.oldDate,' to ').concat(n.newDate,' for ').concat(n.pupilName) }),e.a(2);case 1:return e.p=1,e.n=2,R(o,'booking_changed',n);case 2:i=e.v,console.log('✅ Multi-channel booking change notification sent:',i),e.n=4;break;case 3:e.p=3,r=e.v,console.error('❌ Error sending multi-channel notification:',r),chrome.notifications.create({ type:'basic',iconUrl:'icons/professional/icon128.png',title:'TestNotifier - Booking Changed!',message:'Test moved from '.concat(n.oldDate,' to ').concat(n.newDate,' for ').concat(n.pupilName) });case 4:return e.a(2);}},e,null,[[1,3]]);}))).apply(this,arguments);}function v(){return(v=u(a().m(function e(n,t){var o,r,s,c,u;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(console.log('🤖 Auto-booking executed:',n),o=l.pupils.find(function(e){return e.name===n.pupilName;})){e.n=1;break;}return console.warn('⚠️ Pupil not found in database, sending basic notification only'),chrome.notifications.create({ type:'basic',iconUrl:'icons/professional/icon128.png',title:'TestNotifier - Auto-Booking Complete!',message:''.concat(n.pupilName,' moved to ').concat(n.newDate,' automatically') }),e.a(2);case 1:return e.p=1,console.log('🔍 Starting booking verification process...'),e.n=2,P(o,{ date:n.newDate,time:n.newTime,centre:n.newCentre },{ date:n.oldDate,time:n.oldTime,centre:n.oldCentre });case 2:if(s=e.v,I('auto_booking_executed',i(i({},n),{},{ success:s.success,riskLevel:null===(r=s.riskAssessment)||void 0===r?void 0:r.level })),!s.success){e.n=5;break;}return console.log('✅ Booking verification passed, sending confirmation...'),e.n=3,j(o,n,s);case 3:return c=e.v,console.log('✅ Verified booking confirmation sent:',c),e.n=4,R(o,'auto_booking_executed',n);case 4:e.n=6;break;case 5:return console.warn('⚠️ Booking verification failed, sending alert...'),e.n=6,R(o,'booking_verified',i(i({},n),{},{ verificationResults:i(i({},s),{},{ success:!1 }),confidenceScore:25 }));case 6:e.n=8;break;case 7:e.p=7,u=e.v,console.error('❌ Error in auto-booking verification process:',u),chrome.notifications.create({ type:'basic',iconUrl:'icons/professional/icon128.png',title:'TestNotifier - Auto-Booking Complete!',message:''.concat(n.pupilName,' moved to ').concat(n.newDate,' automatically') });case 8:return e.a(2);}},e,null,[[1,7]]);}))).apply(this,arguments);}function b(){return Math.random().toString(36).substr(2,9);}function y(){return(y=u(a().m(function e(n){var t,o;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,console.log('🔍 Validating subscription for user:',n),t=S(n),l.subscription=t,e.n=1,chrome.storage.local.set({ extensionState:l });case 1:return console.log('✅ Subscription validated:',t),e.a(2,t);case 2:return e.p=2,o=e.v,console.error('❌ Error validating subscription:',o),e.a(2,l.subscription);}},e,null,[[0,2]]);}))).apply(this,arguments);}function w(){return k.apply(this,arguments);}function k(){return(k=u(a().m(function e(){var n,t,o;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,chrome.storage.local.get('extensionState');case 1:return t=e.v,e.a(2,(null===(n=t.extensionState)||void 0===n?void 0:n.subscription)||l.subscription);case 2:return e.p=2,o=e.v,console.error('❌ Error getting subscription:',o),e.a(2,l.subscription);}},e,null,[[0,2]]);}))).apply(this,arguments);}function S(e){var n=e?e.length%5:0;return[{ tier:'free',status:'active',expiresAt:null,features:{ maxTestCenters:1,maxRebooks:0,rapidMode:!1,bulkOperations:!1,advancedFiltering:!1,stealthMode:!1,multiPupil:!1,smsNotifications:!1,whatsappNotifications:!1,emailNotifications:!1 } },{ tier:'one-off',status:'active',expiresAt:new Date(Date.now()+2592e6).toISOString(),features:{ maxTestCenters:1,maxRebooks:1,rapidMode:!1,bulkOperations:!1,advancedFiltering:!1,stealthMode:!1,multiPupil:!1,smsNotifications:!1,whatsappNotifications:!1,emailNotifications:!0 } },{ tier:'starter',status:'active',expiresAt:new Date(Date.now()+2592e6).toISOString(),features:{ maxTestCenters:3,maxRebooks:2,rapidMode:!1,bulkOperations:!1,advancedFiltering:!1,stealthMode:!1,multiPupil:!1,smsNotifications:!0,whatsappNotifications:!1,emailNotifications:!0 } },{ tier:'premium',status:'active',expiresAt:new Date(Date.now()+2592e6).toISOString(),features:{ maxTestCenters:8,maxRebooks:5,rapidMode:!0,bulkOperations:!1,advancedFiltering:!0,stealthMode:!1,multiPupil:!1,smsNotifications:!0,whatsappNotifications:!1,emailNotifications:!0 } },{ tier:'professional',status:'active',expiresAt:new Date(Date.now()+2592e6).toISOString(),features:{ maxTestCenters:999,maxRebooks:999,rapidMode:!0,bulkOperations:!0,advancedFiltering:!0,stealthMode:!0,multiPupil:!0,smsNotifications:!0,whatsappNotifications:!0,emailNotifications:!0 } }][n];}function N(){return(N=u(a().m(function e(){var t,o,i,r,s,c,u,p,f,d;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,l.failedNotifications){e.n=1;break;}return l.failedNotifications=[],e.a(2);case 1:if(t=Date.now(),o=l.failedNotifications.filter(function(e){return e.nextRetryTime&&t>=e.nextRetryTime&&e.retryCount<3&&!e.success;}),0!==o.length){e.n=2;break;}return e.a(2);case 2:console.log('🔄 Retrying '.concat(o.length,' failed notifications...')),i=n(o),e.p=3,i.s();case 4:if((r=i.n()).done){e.n=15;break;}s=r.value,e.p=5,c=null,u=s.channel,e.n='sms'===u?6:'whatsapp'===u?8:'email'===u?10:12;break;case 6:return e.n=7,x(s.recipient,s.message,s.pupilName);case 7:return c=e.v,e.a(3,12);case 8:return e.n=9,A(s.recipient,s.message,s.pupilName);case 9:return c=e.v,e.a(3,12);case 10:return e.n=11,C(s.recipient,s.subject,s.body,s.pupilName);case 11:return c=e.v,e.a(3,12);case 12:c.success?(s.success=!0,s.finalMessageId=c.messageId,console.log('✅ Notification retry successful: '.concat(s.id))):(s.retryCount++,s.lastError=c.error,s.nextRetryTime=t+6e4*Math.pow(2,s.retryCount),console.log('⚠️ Notification retry failed: '.concat(s.id,', will retry in ').concat(Math.pow(2,s.retryCount),' minutes'))),e.n=14;break;case 13:e.p=13,p=e.v,s.retryCount++,s.lastError=p.message,s.nextRetryTime=t+6e4*Math.pow(2,s.retryCount),console.error('❌ Notification retry error: '.concat(s.id),p);case 14:e.n=4;break;case 15:e.n=17;break;case 16:e.p=16,f=e.v,i.e(f);case 17:return e.p=17,i.f(),e.f(17);case 18:return l.failedNotifications=l.failedNotifications.filter(function(e){return!e.success||t-e.timestamp<864e5;}),e.n=19,chrome.storage.local.set({ extensionState:l });case 19:e.n=21;break;case 20:e.p=20,d=e.v,console.error('❌ Error in retry notification process:',d);case 21:return e.a(2);}},e,null,[[5,13],[3,16,17,18],[0,20]]);}))).apply(this,arguments);}function D(e,n,t,o){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;l.failedNotifications||(l.failedNotifications=[]);var a={ id:Date.now().toString(),channel:e,recipient:n,message:t,pupilName:o,subject:i,body:r,timestamp:Date.now(),nextRetryTime:Date.now()+6e4,retryCount:0,success:!1 };l.failedNotifications.push(a),l.failedNotifications.length>50&&(l.failedNotifications=l.failedNotifications.slice(-50)),console.log('📝 Queued failed notification for retry: '.concat(a.id)),chrome.storage.local.set({ extensionState:l }).catch(function(e){console.error('❌ Error saving failed notification:',e);});}function x(e,n){return T.apply(this,arguments);}function T(){return T=u(a().m(function e(n,t){var o,i,r,s,c,u,p,f,d,g,m=arguments;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(o=m.length>2&&void 0!==m[2]?m[2]:'',e.p=1,l.settings.twilio.accountSid&&l.settings.twilio.authToken&&l.settings.twilio.phoneNumber&&l.subscription.features.smsNotifications){e.n=2;break;}return console.log('⚠️ SMS notifications not configured or not available for this tier'),e.a(2,{ success:!1,error:'SMS not configured' });case 2:if((i=n.replace(/[^\d+]/g,'')).match(/^\+?44\d{10}$|^(07|447)\d{9}$/)){e.n=3;break;}return console.log('⚠️ Invalid UK phone number format:',n),e.a(2,{ success:!1,error:'Invalid phone number format' });case 3:return r=i.startsWith('+')?i:'+'+i,console.log('📱 Sending SMS to',r,'for pupil:',o),s='https://api.twilio.com/2010-04-01/Accounts/'.concat(l.settings.twilio.accountSid,'/Messages.json'),c=btoa(''.concat(l.settings.twilio.accountSid,':').concat(l.settings.twilio.authToken)),(u=new FormData).append('To',r),u.append('From',l.settings.twilio.phoneNumber),u.append('Body',t),e.n=4,fetch(s,{ method:'POST',headers:{ Authorization:'Basic '.concat(c) },body:u });case 4:if((p=e.v).ok){e.n=6;break;}return e.n=5,p.text();case 5:return f=e.v,console.error('❌ Twilio SMS failed:',f),e.a(2,{ success:!1,error:'SMS failed: '.concat(f) });case 6:return e.n=7,p.json();case 7:return d=e.v,console.log('✅ SMS sent successfully:',d.sid),B('sms',d.sid,o,'sent'),e.a(2,{ success:!0,messageId:d.sid });case 8:return e.p=8,g=e.v,console.error('❌ Error sending SMS:',g),n&&t&&D('sms',n,t,o),e.a(2,{ success:!1,error:g.message });}},e,null,[[1,8]]);})),T.apply(this,arguments);}function A(e,n){return E.apply(this,arguments);}function E(){return E=u(a().m(function e(n,t){var o,i,r,s,c,u,p,f,d,g,m,h=arguments;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(o=h.length>2&&void 0!==h[2]?h[2]:'',e.p=1,l.settings.twilio.accountSid&&l.settings.twilio.authToken&&l.settings.twilio.phoneNumber&&l.subscription.features.whatsappNotifications){e.n=2;break;}return console.log('⚠️ WhatsApp notifications not configured or not available for this tier'),e.a(2,{ success:!1,error:'WhatsApp not configured' });case 2:if((i=n.replace(/[^\d+]/g,'')).match(/^\+?44\d{10}$|^(07|447)\d{9}$/)){e.n=3;break;}return console.log('⚠️ Invalid UK phone number format for WhatsApp:',n),e.a(2,{ success:!1,error:'Invalid phone number format' });case 3:return r=i.startsWith('+')?i:'+'+i,s='whatsapp:'.concat(r),console.log('💬 Sending WhatsApp to',s,'for pupil:',o),c='https://api.twilio.com/2010-04-01/Accounts/'.concat(l.settings.twilio.accountSid,'/Messages.json'),u=btoa(''.concat(l.settings.twilio.accountSid,':').concat(l.settings.twilio.authToken)),(p=new FormData).append('To',s),p.append('From','whatsapp:'.concat(l.settings.twilio.phoneNumber)),p.append('Body',t),e.n=4,fetch(c,{ method:'POST',headers:{ Authorization:'Basic '.concat(u) },body:p });case 4:if((f=e.v).ok){e.n=6;break;}return e.n=5,f.text();case 5:return d=e.v,console.error('❌ Twilio WhatsApp failed:',d),e.a(2,{ success:!1,error:'WhatsApp failed: '.concat(d) });case 6:return e.n=7,f.json();case 7:return g=e.v,console.log('✅ WhatsApp message sent successfully:',g.sid),B('whatsapp',g.sid,o,'sent'),e.a(2,{ success:!0,messageId:g.sid });case 8:return e.p=8,m=e.v,console.error('❌ Error sending WhatsApp message:',m),n&&t&&D('whatsapp',n,t,o),e.a(2,{ success:!1,error:m.message });}},e,null,[[1,8]]);})),E.apply(this,arguments);}function C(e,n,t){return O.apply(this,arguments);}function O(){return O=u(a().m(function e(n,t,o){var i,r,s,c=arguments;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(i=c.length>3&&void 0!==c[3]?c[3]:'',e.p=1,l.subscription.features.emailNotifications){e.n=2;break;}return console.log('⚠️ Email notifications not available for this tier'),e.a(2,{ success:!1,error:'Email not available' });case 2:if(n.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){e.n=3;break;}return console.log('⚠️ Invalid email address:',n),e.a(2,{ success:!1,error:'Invalid email format' });case 3:return console.log('📧 Sending email to',n,'for pupil:',i),r={ to:n,subject:t,body:o,pupilName:i,timestamp:(new Date).toISOString(),status:'pending' },l.pendingEmails||(l.pendingEmails=[]),l.pendingEmails.push(r),e.n=4,chrome.storage.local.set({ extensionState:l });case 4:return console.log('✅ Email queued for sending:',r),B('email',Date.now().toString(),i,'queued'),e.a(2,{ success:!0,messageId:Date.now().toString() });case 5:return e.p=5,s=e.v,console.error('❌ Error sending email:',s),n&&t&&o&&D('email',n,null,i,t,o),e.a(2,{ success:!1,error:s.message });}},e,null,[[1,5]]);})),O.apply(this,arguments);}function B(e,n,t,o){console.log('📊 Tracking '.concat(e,' delivery: ').concat(o,' - ').concat(n,' for ').concat(t)),l.notificationHistory||(l.notificationHistory=[]),l.notificationHistory.push({ channel:e,messageId:n,pupilName:t,status:o,timestamp:(new Date).toISOString() }),l.notificationHistory.length>100&&(l.notificationHistory=l.notificationHistory.slice(-100)),chrome.storage.local.set({ extensionState:l }).catch(function(e){console.error('❌ Error saving notification history:',e);});}function P(e,n,t){return M.apply(this,arguments);}function M(){return(M=u(a().m(function e(n,t,o){var i,r,s,c,u,l;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,console.log('🔍 Verifying booking change for pupil:',n.name),(i={ success:!0,timestamp:(new Date).toISOString(),oldBooking:o,newBooking:{ date:t.date,time:t.time,centre:t.centre },verificationSteps:[] }).verificationSteps.push({ step:'availability_check',status:'passed',message:'New slot appears to be available' }),n.licenceNumber&&i.verificationSteps.push({ step:'licence_validation',status:'passed',message:'Driving licence number format validated' }),i.verificationSteps.push({ step:'conflict_check',status:'passed',message:'No conflicting bookings detected' }),r=new Date(o.date),s=new Date(t.date),(c=Math.floor((r-s)/864e5))>0&&(i.verificationSteps.push({ step:'time_advantage_check',status:'passed',message:'Booking moved '.concat(c,' days earlier') }),i.daysEarlier=c),e.n=1,assessBookingRisk(t);case 1:return u=e.v,i.riskAssessment=u,'HIGH'===u.level&&(i.warnings=['High-risk booking detected - manual review recommended']),console.log('✅ Booking verification completed:',i),e.a(2,i);case 2:return e.p=2,l=e.v,console.error('❌ Error verifying booking change:',l),e.a(2,{ success:!1,error:l.message,timestamp:(new Date).toISOString() });}},e,null,[[0,2]]);}))).apply(this,arguments);}function I(e,n){l.analytics||(l.analytics={ totalBookings:0,successfulBookings:0,failedBookings:0,autoBookings:0,manualBookings:0,averageTimeSavings:0,bookingHistory:[] });var t=l.analytics;t.totalBookings++;var o={ id:Date.now().toString(),eventType:e,timestamp:(new Date).toISOString(),pupilName:n.pupilName,oldDate:n.oldDate,newDate:n.newDate,success:!1!==n.success,autoExecuted:n.autoExecuted||!1,timeSavings:n.timeSavings||null,riskLevel:n.riskLevel||'unknown' };switch(e){case'booking_changed':n.success?(t.successfulBookings++,n.autoExecuted?t.autoBookings++:t.manualBookings++):t.failedBookings++;break;case'auto_booking_executed':t.autoBookings++,n.success?t.successfulBookings++:t.failedBookings++;}if(n.timeSavings&&'number'==typeof n.timeSavings){var i=t.averageTimeSavings,r=t.successfulBookings;t.averageTimeSavings=(i*(r-1)+n.timeSavings)/r;}t.bookingHistory.unshift(o),t.bookingHistory.length>100&&(t.bookingHistory=t.bookingHistory.slice(0,100)),chrome.storage.local.set({ extensionState:l }).catch(function(e){console.error('❌ Error saving analytics:',e);}),console.log('📊 Booking analytics updated:',t);}function j(e,n,t){return _.apply(this,arguments);}function _(){return(_=u(a().m(function e(n,t,o){var r,s,c,u;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,console.log('📤 Sending booking confirmation for:',n.name),s=i(i({},t),{},{ verificationResults:o,confidenceScore:o.success?95:50,recommendedActions:[] }),'HIGH'===(null===(r=o.riskAssessment)||void 0===r?void 0:r.level)&&(s.recommendedActions.push('Monitor booking closely for next 24 hours'),s.recommendedActions.push('Contact pupil to confirm test details')),o.daysEarlier>30&&s.recommendedActions.push('Significant time advancement - consider confirming with DVSA'),o.success||(s.recommendedActions.push('Verification failed - manual review required'),s.recommendedActions.push('Contact support if issues persist')),e.n=1,R(n,'booking_verified',s);case 1:return c=e.v,I('booking_verified',i(i({},t),{},{ verificationSuccess:o.success,confidenceScore:s.confidenceScore })),e.a(2,c);case 2:return e.p=2,u=e.v,console.error('❌ Error sending booking confirmation:',u),e.a(2,{ success:!1,error:u.message });}},e,null,[[0,2]]);}))).apply(this,arguments);}function R(e,n,t){return F.apply(this,arguments);}function F(){return(F=u(a().m(function e(n,t,o){var i,r,s,c,u,p,f,d,g,m,h,v,b;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:e.p=0,console.log('📡 Sending '.concat(t,' notification for pupil:'),n.name),r={ sms:null,whatsapp:null,email:null,chrome:null },s='',c='',u='',v=t,e.n='cancellation_found'===v?1:'booking_changed'===v?2:'auto_booking_executed'===v?3:'booking_verified'===v?4:5;break;case 1:return s='🎯 TestNotifier: Earlier slot found! '.concat(o.newDate,' at ').concat(o.newCentre,' for ').concat(n.name,'. Check your extension now!'),c='Earlier Test Slot Found - '.concat(n.name),u='\n          <h2>🎯 Earlier Test Slot Found!</h2>\n          <p><strong>Pupil:</strong> '.concat(n.name,'</p>\n          <p><strong>New Date:</strong> ').concat(o.newDate,'</p>\n          <p><strong>New Time:</strong> ').concat(o.newTime,'</p>\n          <p><strong>Test Centre:</strong> ').concat(o.newCentre,'</p>\n          <p><strong>Current Booking:</strong> ').concat(o.currentDate||'Unknown','</p>\n          <br>\n          <p><strong>Next Steps:</strong></p>\n          <p>1. Open your Chrome extension</p>\n          <p>2. Review the available slot</p>\n          <p>3. Proceed with rebooking if desired</p>\n          <br>\n          <p><em>This notification was sent by TestNotifier - Your DVSA test cancellation finder</em></p>\n        '),e.a(3,5);case 2:return s='✅ TestNotifier: Booking changed! '.concat(n.name,' moved from ').concat(o.oldDate,' to ').concat(o.newDate,'.'),c='Booking Successfully Changed - '.concat(n.name),u='\n          <h2>✅ Booking Successfully Changed!</h2>\n          <p><strong>Pupil:</strong> '.concat(n.name,'</p>\n          <p><strong>Old Date:</strong> ').concat(o.oldDate,'</p>\n          <p><strong>New Date:</strong> ').concat(o.newDate,'</p>\n          <p><strong>Test Centre:</strong> ').concat(o.newCentre||'Same centre','</p>\n          <br>\n          <p>Your pupil\'s test has been successfully moved to an earlier slot!</p>\n          <br>\n          <p><em>TestNotifier - Your DVSA test cancellation finder</em></p>\n        '),e.a(3,5);case 3:return s='🤖 TestNotifier: Auto-booking executed! '.concat(n.name,' moved to ').concat(o.newDate,'. No action needed.'),c='Auto-Booking Completed - '.concat(n.name),u='\n          <h2>🤖 Auto-Booking Successfully Completed!</h2>\n          <p><strong>Pupil:</strong> '.concat(n.name,'</p>\n          <p><strong>Previous Date:</strong> ').concat(o.oldDate,'</p>\n          <p><strong>New Date:</strong> ').concat(o.newDate,'</p>\n          <p><strong>Time Savings:</strong> ').concat(o.timeSavings||'Calculated','</p>\n          <br>\n          <p>The booking was automatically executed with full stealth protection.</p>\n          <p>No further action is required from you.</p>\n          <br>\n          <p><em>TestNotifier Professional - Automated DVSA test management</em></p>\n        '),e.a(3,5);case 4:return p=o.verificationResults,f=o.confidenceScore||0,d=(null===(i=p.riskAssessment)||void 0===i?void 0:i.level)||'unknown',s='✅ TestNotifier: Booking verified for '.concat(n.name,'! ').concat(o.newDate,' (').concat(f,'% confidence)'),c='Booking Verification Complete - '.concat(n.name),g='',p.verificationSteps&&(g=p.verificationSteps.map(function(e){return'<li><strong>'.concat(e.step,':</strong> ').concat(e.message,'</li>');}).join('')),m='',o.recommendedActions&&o.recommendedActions.length>0&&(m='\n            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin: 16px 0;">\n              <h4 style="color: #856404; margin-bottom: 8px;">📋 Recommended Actions:</h4>\n              <ul style="color: #856404; margin: 0; padding-left: 20px;">\n                '.concat(o.recommendedActions.map(function(e){return'<li>'.concat(e,'</li>');}).join(''),'\n              </ul>\n            </div>\n          ')),u='\n          <h2>✅ Booking Verification Complete!</h2>\n          <p><strong>Pupil:</strong> '.concat(n.name,'</p>\n          <p><strong>Verification Status:</strong> ').concat(p.success?'PASSED':'FAILED','</p>\n          <p><strong>Confidence Score:</strong> ').concat(f,'%</p>\n          <p><strong>Risk Level:</strong> <span style="color: ').concat('HIGH'===d?'#dc3545':'MEDIUM'===d?'#ffc107':'#28a745','">').concat(d,'</span></p>\n\n          ').concat(p.daysEarlier?'<p><strong>Time Advantage:</strong> '.concat(p.daysEarlier,' days earlier</p>'):'','\n\n          <br>\n          <h4>🔍 Verification Steps:</h4>\n          <ul>\n            ').concat(g,'\n          </ul>\n\n          ').concat(m,'\n\n          <br>\n          <p><em>TestNotifier - Intelligent DVSA test management with verification</em></p>\n        '),e.a(3,5);case 5:if(h=n.contact||{},!l.subscription.features.smsNotifications||!h.phone){e.n=7;break;}return e.n=6,x(h.phone,s,n.name);case 6:r.sms=e.v;case 7:if(!l.subscription.features.whatsappNotifications||!h.phone){e.n=9;break;}return e.n=8,A(h.phone,s,n.name);case 8:r.whatsapp=e.v;case 9:if(!l.subscription.features.emailNotifications||!h.email){e.n=11;break;}return e.n=10,C(h.email,c,u,n.name);case 10:r.email=e.v;case 11:if(!l.settings.notifications){e.n=13;break;}return e.n=12,H(t,o,n);case 12:r.chrome=e.v;case 13:return console.log('✅ Multi-channel notification results:',r),e.a(2,r);case 14:return e.p=14,b=e.v,console.error('❌ Error sending multi-channel notification:',b),e.a(2,{ error:b.message });}},e,null,[[0,14]]);}))).apply(this,arguments);}function H(e,n,t){return U.apply(this,arguments);}function U(){return(U=u(a().m(function e(n,t,o){var i,r,s,c;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:e.p=0,i='',r='',s=n,e.n='cancellation_found'===s?1:'booking_changed'===s?2:'auto_booking_executed'===s?3:4;break;case 1:return i='TestNotifier - Cancellation Found!',r='Earlier test available for '.concat(o.name,': ').concat(t.newDate,' at ').concat(t.newCentre),e.a(3,4);case 2:return i='TestNotifier - Booking Changed!',r='Test moved from '.concat(t.oldDate,' to ').concat(t.newDate,' for ').concat(o.name),e.a(3,4);case 3:return i='TestNotifier - Auto-Booking Complete!',r=''.concat(o.name,' moved to ').concat(t.newDate,' automatically'),e.a(3,4);case 4:return chrome.notifications.create({ type:'basic',iconUrl:'icons/professional/icon128.png',title:i,message:r }),e.a(2,{ success:!0 });case 5:return e.p=5,c=e.v,console.error('❌ Error sending Chrome notification:',c),e.a(2,{ success:!1,error:c.message });}},e,null,[[0,5]]);}))).apply(this,arguments);}function V(){return(V=u(a().m(function e(n){var t,o,i,r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,console.log('📋 Adding new pupil:',n),n.name&&n.licenceNumber&&n.testCentre){e.n=1;break;}return e.a(2,{ success:!1,error:'Missing required fields' });case 1:if(/^[A-Z0-9]{16}$/.test(n.licenceNumber)){e.n=2;break;}return e.a(2,{ success:!1,error:'Invalid driving licence number format' });case 2:return e.n=3,w();case 3:if(t=e.v,o=t.features.multiPupil?999:1,!(l.pupils.length>=o)){e.n=4;break;}return e.a(2,{ success:!1,error:'Subscription limit reached. Maximum '.concat(o,' pupil').concat(1!==o?'s':'',' allowed.') });case 4:return i={ id:b(),name:n.name,licenceNumber:n.licenceNumber,testCentre:n.testCentre,preferredDates:{ from:n.dateFrom||null,to:n.dateTo||null },contact:{ phone:n.phone||'',email:n.email||'' },status:'active',createdAt:(new Date).toISOString(),lastCheck:null,currentBooking:null,notificationsEnabled:!0 },l.pupils.push(i),e.n=5,chrome.storage.local.set({ extensionState:l });case 5:return console.log('✅ Pupil added successfully:',i.name),l.settings.notifications&&chrome.notifications.create({ type:'basic',iconUrl:'icons/professional/icon128.png',title:'TestNotifier - Pupil Added',message:'Successfully added '.concat(i.name,' for monitoring') }),e.a(2,{ success:!0,pupil:i });case 6:return e.p=6,r=e.v,console.error('❌ Error adding pupil:',r),e.a(2,{ success:!1,error:r.message });}},e,null,[[0,6]]);}))).apply(this,arguments);}chrome.runtime.onInstalled.addListener(function(){console.log('🚀 DVSA Queen extension installed'),chrome.storage.local.set({ extensionState:l,firstRun:!0 }),setInterval(function(){!function(){N.apply(this,arguments);}();},3e4),console.log('🔄 Notification retry scheduler started');}),chrome.runtime.onMessage.addListener(function(e,n,t){switch(console.log('📨 Background received message:',e),e.action){case'getState':return function(){return p.apply(this,arguments);}().then(function(e){t({ success:!0,state:e });}),!0;case'updateState':return function(e){return f.apply(this,arguments);}(e.data).then(function(){t({ success:!0 });}),!0;case'foundCancellation':!function(e,n){m.apply(this,arguments);}(e.data,n.tab);break;case'bookingChanged':!function(e,n){h.apply(this,arguments);}(e.data,n.tab);break;case'autoBookingExecuted':!function(e,n){v.apply(this,arguments);}(e.data,n.tab);break;case'errorOccurred':o=e.data,n.tab,console.error('❌ Extension error:',o),chrome.notifications.create({ type:'basic',iconUrl:'icons/professional/icon128.png',title:'TestNotifier - Error',message:'Error: '.concat(o.message) });break;case'getSettings':return function(){return d.apply(this,arguments);}().then(function(e){t({ success:!0,settings:e });}),!0;case'updateSettings':return function(e){return g.apply(this,arguments);}(e.data).then(function(){t({ success:!0 });}),!0;case'validateSubscription':return function(e){return y.apply(this,arguments);}(e.userId).then(function(e){t({ success:!0,subscription:e });}),!0;case'getSubscription':return w().then(function(e){t({ success:!0,subscription:e });}),!0;case'addPupil':return function(e){return V.apply(this,arguments);}(e.data).then(function(e){t(e);}),!0;default:console.warn('⚠️ Unknown message action:',e.action);}var o;}),chrome.tabs.onUpdated.addListener(function(e,n,t){var o;'complete'===n.status&&null!==(o=t.url)&&void 0!==o&&o.includes('driverpracticaltest.dvsa.gov.uk')&&(console.log('🌐 DVSA page loaded:',t.url),(t.url.includes('change')||t.url.includes('manage'))&&chrome.tabs.sendMessage(e,{ action:'pageLoaded',url:t.url }));}),chrome.action.onClicked.addListener(function(e){var n;null!==(n=e.url)&&void 0!==n&&n.includes('driverpracticaltest.dvsa.gov.uk')&&chrome.tabs.sendMessage(e.id,{ action:'toggleInterface' });}),console.log('🔧 DVSA Queen background script loaded');})();
